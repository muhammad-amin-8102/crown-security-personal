# 502 Bad Gateway Fix Guide

## Problem Diagnosis
The 502 Bad Gateway error indicates the backend API is not responding. This is typically caused by:
1. Missing environment variables (JWT secrets, DATABASE_URL)
2. Database connection failure
3. Server startup failure

## Immediate Fixes Applied

### 1. Updated render-fullstack.yaml
Added missing environment variables:
- `JWT_ACCESS_SECRET` (auto-generated by Render)
- `JWT_REFRESH_SECRET` (auto-generated by Render)
- `DATABASE_URL` (linked to PostgreSQL database)

### 2. Added Debug Endpoint
- `/debug` endpoint to check environment variables
- Enhanced error handling in login route

### 3. Environment Variable Configuration
```yaml
envVars:
  - key: JWT_ACCESS_SECRET
    generateValue: true
  - key: JWT_REFRESH_SECRET  
    generateValue: true
  - key: DATABASE_URL
    fromDatabase:
      name: crown-security-db
      property: connectionString
```

## Deployment Steps

### Option 1: Manual Environment Setup (Render Dashboard)

1. **Go to Render Dashboard**
   - Visit https://dashboard.render.com
   - Find your `crown-security-fullstack` service

2. **Add Environment Variables**
   ```
   JWT_ACCESS_SECRET: [Generate 32+ character random string]
   JWT_REFRESH_SECRET: [Generate 32+ character random string]
   DATABASE_URL: [Copy from PostgreSQL service]
   ```

3. **Get DATABASE_URL**
   - Go to your PostgreSQL service dashboard
   - Copy the "External Database URL"
   - Add it as DATABASE_URL environment variable

4. **Redeploy**
   - Trigger manual deploy or push changes to GitHub

### Option 2: Infrastructure as Code (Recommended)

1. **Push Updated Configuration**
   ```bash
   git add render-fullstack.yaml
   git commit -m "Fix 502 error - add missing environment variables"
   git push origin main
   ```

2. **Create New Service**
   - Delete existing service (if any)
   - Create new service using updated `render-fullstack.yaml`
   - Render will auto-configure environment variables

## Verification Steps

### 1. Check Service Status
```bash
# Health check
curl https://crown-security-fullstack.onrender.com/health

# Debug info
curl https://crown-security-fullstack.onrender.com/debug
```

### 2. Manual Database Seeding
```bash
# Trigger manual seeding (if auto-seeding failed)
curl -X POST https://crown-security-fullstack.onrender.com/seed
```

### 3. Test Login Endpoint
```bash
# Test with seeded admin user
curl -X POST https://crown-security-fullstack.onrender.com/api/v1/auth/login \
  -H "Content-Type: application/json" \
  -d '{"email":"admin@crownsecurity.com","password":"Admin@2025!"}'
```

### 4. Check Logs
- Go to Render dashboard
- View service logs for startup errors
- Look for database connection and seeding messages

## Common Issues & Solutions

### Database Connection Failed
```
Error: Database connection failed
```
**Solution**: Ensure DATABASE_URL is correctly set and PostgreSQL service is running

### Missing JWT Secrets
```
Error: JWT_ACCESS_SECRET is not defined
```
**Solution**: Add JWT secrets in environment variables

### Port Issues
```
Error: EADDRINUSE
```
**Solution**: Ensure PORT environment variable is set to 10000

## Environment Variables Checklist

Required for production:
- [ ] `NODE_ENV=production`
- [ ] `PORT=10000`
- [ ] `DATABASE_URL` (from PostgreSQL service)
- [ ] `JWT_ACCESS_SECRET` (32+ characters)
- [ ] `JWT_REFRESH_SECRET` (32+ characters)
- [ ] `FRONTEND_URL` (your app domain)

Admin User Configuration:
- [ ] `ADMIN_EMAIL=admin@crownsecurity.com`
- [ ] `ADMIN_NAME=Crown Security Admin`
- [ ] `ADMIN_PHONE=+1-555-0123`
- [ ] `ADMIN_PASSWORD=Admin@2025!`

## Default Admin Credentials

After deployment, you can login with:
- **Email**: `admin@crownsecurity.com`
- **Password**: `Admin@2025!`
- **Role**: ADMIN (full access)

⚠️ **Security Note**: Change the admin password after first login!

## Next Steps

1. **Commit and push the fixes**
2. **Update Render service configuration**
3. **Test all endpoints**
4. **Verify Flutter web login works**

The 502 error should be resolved once the missing environment variables are properly configured!
